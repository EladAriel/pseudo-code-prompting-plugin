name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  validate-json:
    name: Validate JSON Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate plugin.json
        run: |
          if ! jq empty plugin.json 2>/dev/null; then
            echo "❌ plugin.json is invalid"
            exit 1
          fi
          echo "✅ plugin.json is valid"

      - name: Validate marketplace.json
        run: |
          if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
            echo "❌ marketplace.json is invalid"
            exit 1
          fi
          echo "✅ marketplace.json is valid"

      - name: Validate hooks.json
        run: |
          if ! jq empty hooks/hooks.json 2>/dev/null; then
            echo "❌ hooks/hooks.json is invalid"
            exit 1
          fi
          echo "✅ hooks/hooks.json is valid"

      - name: Verify version consistency
        run: |
          PLUGIN_VERSION=$(jq -r '.version' plugin.json)
          MARKETPLACE_VERSION=$(jq -r '.version' .claude-plugin/marketplace.json)

          if [ "$PLUGIN_VERSION" != "$MARKETPLACE_VERSION" ]; then
            echo "❌ Version mismatch: plugin.json ($PLUGIN_VERSION) vs marketplace.json ($MARKETPLACE_VERSION)"
            exit 1
          fi
          echo "✅ Versions are consistent: $PLUGIN_VERSION"

  validate-bash:
    name: Validate Bash Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Check bash syntax for hooks
        run: |
          echo "Checking bash scripts..."
          EXIT_CODE=0
          while IFS= read -r file; do
            echo "Checking $file"
            if ! bash -n "$file"; then
              EXIT_CODE=1
            else
              echo "✅ $file syntax OK"
            fi
          done < <(find hooks -name "*.sh" -type f)
          exit $EXIT_CODE

      - name: Run shellcheck on hooks
        run: |
          echo "Running shellcheck..."
          EXIT_CODE=0
          while IFS= read -r file; do
            echo "Shellcheck: $file"
            if ! shellcheck -x "$file"; then
              EXIT_CODE=1
            else
              echo "✅ $file passed shellcheck"
            fi
          done < <(find hooks -name "*.sh" -type f)
          exit $EXIT_CODE

  validate-python:
    name: Validate Python Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Check Python syntax
        run: |
          echo "Checking Python scripts..."
          find hooks -name "*.py" -type f | while read -r file; do
            echo "Checking $file"
            python -m py_compile "$file" || exit 1
            echo "✅ $file syntax OK"
          done

      - name: Test get_context_tree.py execution
        run: |
          echo "Testing get_context_tree.py..."
          python hooks/tree/get_context_tree.py --help || exit 1
          echo "✅ get_context_tree.py help works"

          # Test on current directory
          python hooks/tree/get_context_tree.py . --max-depth 2 --max-files 50
          echo "✅ get_context_tree.py execution successful"

  validate-markdown:
    name: Validate Markdown Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          echo "Linting markdown files..."
          markdownlint '**/*.md' --ignore node_modules --ignore .github || true
          echo "✅ Markdown lint complete"

      - name: Check for broken internal links
        run: |
          echo "Checking internal markdown links..."
          # Simple check for broken relative links in docs
          for file in docs/*.md commands/*.md agents/*.md; do
            if [ -f "$file" ]; then
              echo "Checking links in $file"
              # Extract markdown links [text](path.md)
              grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$file" | while read -r link; do
                # Skip external URLs
                if [[ "$link" =~ ^https?:// ]]; then
                  continue
                fi
                # Skip anchor links (internal page links starting with #)
                if [[ "$link" =~ ^# ]]; then
                  continue
                fi
                # Skip directory links (ending with /)
                if [[ "$link" =~ /$ ]]; then
                  continue
                fi
                # Check if file exists (relative to file location)
                # Strip anchor fragment (#...) from link before checking
                target="${link%%#*}"
                dir=$(dirname "$file")
                if [ ! -f "$dir/$target" ] && [ ! -f "$target" ]; then
                  echo "❌ Broken link in $file: $link"
                  exit 1
                fi
              done || exit 1
            fi
          done
          echo "✅ Internal links OK"

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Test hook execution simulation
        run: |
          echo "Testing context-aware-tree-injection hook..."

          # Simulate hook input
          echo '{"prompt":"implement user authentication","cwd":"'$(pwd)'"}' | bash hooks/tree/context-aware-tree-injection.sh

          echo "✅ Hook execution test passed"

      - name: Test Python script with various scenarios
        run: |
          echo "Testing empty directory detection..."
          mkdir -p /tmp/empty-test
          output=$(python hooks/tree/get_context_tree.py /tmp/empty-test)
          if [[ "$output" != *"<<PROJECT_EMPTY_NO_STRUCTURE>>"* ]]; then
            echo "❌ Empty detection failed"
            exit 1
          fi
          echo "✅ Empty detection works"

          echo "Testing tree generation..."
          python hooks/tree/get_context_tree.py . --max-depth 3 --max-files 100
          echo "✅ Tree generation works"

      - name: Verify plugin structure
        run: |
          echo "Verifying plugin file structure..."

          # Check required files
          required_files=(
            "plugin.json"
            ".claude-plugin/marketplace.json"
            "hooks/hooks.json"
            "hooks/tree/get_context_tree.py"
            "hooks/tree/context-aware-tree-injection.sh"
            "hooks/core/user-prompt-submit.sh"
            "README.md"
            "CHANGELOG.md"
            "LICENSE"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

          echo "✅ Plugin structure verified"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-json, validate-bash, validate-python, validate-markdown, integration-test]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.validate-json.result }}" != "success" ]]; then
            echo "❌ JSON validation failed"
            exit 1
          fi
          if [[ "${{ needs.validate-bash.result }}" != "success" ]]; then
            echo "❌ Bash validation failed"
            exit 1
          fi
          if [[ "${{ needs.validate-python.result }}" != "success" ]]; then
            echo "❌ Python validation failed"
            exit 1
          fi
          if [[ "${{ needs.validate-markdown.result }}" != "success" ]]; then
            echo "❌ Markdown validation failed"
            exit 1
          fi
          if [[ "${{ needs.integration-test.result }}" != "success" ]]; then
            echo "❌ Integration test failed"
            exit 1
          fi

          echo "✅ All CI checks passed!"
