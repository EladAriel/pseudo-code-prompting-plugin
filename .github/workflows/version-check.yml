name: Version Check

on:
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]

jobs:
  check-version-bump:
    name: Check Version Bump
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get base branch version
        id: base-version
        run: |
          git fetch origin ${{ github.base_ref }}
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:plugin.json | jq -r '.version')
          echo "version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Base version: $BASE_VERSION"

      - name: Get PR branch version
        id: pr-version
        run: |
          PR_VERSION=$(jq -r '.version' plugin.json)
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "PR version: $PR_VERSION"

      - name: Compare versions
        id: compare
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.version }}"
          PR_VERSION="${{ steps.pr-version.outputs.version }}"

          echo "Comparing versions:"
          echo "  Base: $BASE_VERSION"
          echo "  PR:   $PR_VERSION"

          # Parse versions
          IFS='.' read -r base_major base_minor base_patch <<< "$BASE_VERSION"
          IFS='.' read -r pr_major pr_minor pr_patch <<< "$PR_VERSION"

          # Determine if version was bumped
          bumped=false
          bump_type=""

          if [ "$pr_major" -gt "$base_major" ]; then
            bumped=true
            bump_type="major"
          elif [ "$pr_major" -eq "$base_major" ] && [ "$pr_minor" -gt "$base_minor" ]; then
            bumped=true
            bump_type="minor"
          elif [ "$pr_major" -eq "$base_major" ] && [ "$pr_minor" -eq "$base_minor" ] && [ "$pr_patch" -gt "$base_patch" ]; then
            bumped=true
            bump_type="patch"
          fi

          echo "bumped=$bumped" >> $GITHUB_OUTPUT
          echo "bump_type=$bump_type" >> $GITHUB_OUTPUT

          if [ "$bumped" = "true" ]; then
            echo "✅ Version bumped: $BASE_VERSION → $PR_VERSION ($bump_type)"
          else
            echo "ℹ️  No version bump detected"
          fi

  check-changelog:
    name: Check CHANGELOG Update
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if CHANGELOG was modified
        id: changelog-check
        run: |
          git fetch origin ${{ github.base_ref }}

          # Check if CHANGELOG.md was modified in this PR
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "modified=true" >> $GITHUB_OUTPUT
            echo "✅ CHANGELOG.md was modified"
          else
            echo "modified=false" >> $GITHUB_OUTPUT
            echo "⚠️  CHANGELOG.md was not modified"
          fi

      - name: Verify CHANGELOG format
        if: steps.changelog-check.outputs.modified == 'true'
        run: |
          echo "Checking CHANGELOG format..."

          # Check for version headers
          if ! grep -q "## \[" CHANGELOG.md; then
            echo "⚠️  CHANGELOG missing version headers"
            exit 1
          fi

          echo "✅ CHANGELOG format looks good"

  check-version-consistency:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify version consistency
        run: |
          echo "Checking version consistency across files..."

          PLUGIN_VERSION=$(jq -r '.version' plugin.json)
          MARKETPLACE_VERSION=$(jq -r '.version' .claude-plugin/marketplace.json)

          echo "Versions found:"
          echo "  plugin.json:      $PLUGIN_VERSION"
          echo "  marketplace.json: $MARKETPLACE_VERSION"

          if [ "$PLUGIN_VERSION" != "$MARKETPLACE_VERSION" ]; then
            echo "❌ Version mismatch detected!"
            echo "   plugin.json: $PLUGIN_VERSION"
            echo "   marketplace.json: $MARKETPLACE_VERSION"
            echo ""
            echo "Please ensure both files have the same version."
            exit 1
          fi

          echo "✅ Versions are consistent: $PLUGIN_VERSION"

      - name: Check if CHANGELOG mentions version
        run: |
          PLUGIN_VERSION=$(jq -r '.version' plugin.json)

          if grep -q "## \[$PLUGIN_VERSION\]" CHANGELOG.md; then
            echo "✅ CHANGELOG has entry for version $PLUGIN_VERSION"
          else
            echo "⚠️  CHANGELOG doesn't have entry for version $PLUGIN_VERSION"
            echo "   Consider adding a CHANGELOG entry for this version."
            # Don't fail - just warn
          fi

  check-conventional-commits:
    name: Check Conventional Commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "Checking commit message format..."

          # Get commits in this PR
          commits=$(git log --format="%H %s" origin/${{ github.base_ref }}..HEAD)

          # Conventional commit regex
          pattern="^[0-9a-f]+ (feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?: .+"

          fail=false
          while IFS= read -r commit; do
            if [ -n "$commit" ]; then
              if ! echo "$commit" | grep -qE "$pattern"; then
                echo "⚠️  Non-conventional commit: $commit"
                fail=true
              else
                echo "✅ $commit"
              fi
            fi
          done <<< "$commits"

          if [ "$fail" = "true" ]; then
            echo ""
            echo "Some commits don't follow conventional commit format."
            echo "Expected format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci, revert"
            echo ""
            echo "Examples:"
            echo "  feat: add new transformation command"
            echo "  fix(hooks): resolve tree generation timeout"
            echo "  docs: update README with examples"
            echo ""
            echo "Note: This is a warning, not a failure."
          else
            echo "✅ All commits follow conventional commit format"
          fi

  validate-modified-files:
    name: Validate Modified Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Validate modified JSON files
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "Checking modified JSON files..."

          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.json$' | while read -r file; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              if ! jq empty "$file" 2>/dev/null; then
                echo "❌ $file has invalid JSON"
                exit 1
              fi
              echo "✅ $file is valid JSON"
            fi
          done || exit 1

      - name: Validate modified bash scripts
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "Checking modified bash scripts..."

          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.sh$' | while read -r file; do
            if [ -f "$file" ]; then
              echo "Checking syntax: $file..."
              if ! bash -n "$file" 2>/dev/null; then
                echo "❌ $file has syntax errors"
                exit 1
              fi
              echo "✅ $file syntax OK"
            fi
          done || exit 1

      - name: Validate modified Python scripts
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "Checking modified Python scripts..."

          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' | while read -r file; do
            if [ -f "$file" ]; then
              echo "Checking syntax: $file..."
              if ! python -m py_compile "$file" 2>/dev/null; then
                echo "❌ $file has syntax errors"
                exit 1
              fi
              echo "✅ $file syntax OK"
            fi
          done || exit 1

  summary:
    name: PR Check Summary
    runs-on: ubuntu-latest
    needs: [check-version-bump, check-changelog, check-version-consistency, check-conventional-commits, validate-modified-files]
    if: always()
    steps:
      - name: Summarize checks
        run: |
          echo "## PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Version bump status
          if [[ "${{ needs.check-version-bump.result }}" == "success" ]]; then
            echo "✅ Version bump check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Version bump check failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Changelog status
          if [[ "${{ needs.check-changelog.result }}" == "success" ]]; then
            echo "✅ CHANGELOG check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ CHANGELOG check failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Version consistency status
          if [[ "${{ needs.check-version-consistency.result }}" == "success" ]]; then
            echo "✅ Version consistency check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Version consistency check failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Conventional commits status
          if [[ "${{ needs.check-conventional-commits.result }}" == "success" ]]; then
            echo "✅ Conventional commits check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️  Conventional commits check completed with warnings" >> $GITHUB_STEP_SUMMARY
          fi

          # File validation status
          if [[ "${{ needs.validate-modified-files.result }}" == "success" ]]; then
            echo "✅ Modified files validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Modified files validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.check-version-consistency.result }}" != "success" ]] ||
             [[ "${{ needs.validate-modified-files.result }}" != "success" ]]; then
            echo "❌ Some critical checks failed. Please review and fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ All critical checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
